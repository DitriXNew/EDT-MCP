<?xml version="1.0" encoding="UTF-8"?>
<?eclipse version="3.4"?>
<plugin>
   <!-- Preferences page -->
   <extension point="org.eclipse.ui.preferencePages">
      <page
            id="com.ditrix.edt.mcp.server.preferences"
            name="MCP Server"
            class="com.ditrix.edt.mcp.server.preferences.McpServerPreferencePage">
      </page>
   </extension>
   
   <!-- Default preferences initializer -->
   <extension point="org.eclipse.core.runtime.preferences">
      <initializer class="com.ditrix.edt.mcp.server.preferences.PreferenceInitializer"/>
   </extension>
   
   <!-- Startup for auto-starting server if enabled -->
   <extension point="org.eclipse.ui.startup">
      <startup class="com.ditrix.edt.mcp.server.McpServerStartup"/>
   </extension>
   
   <!-- Commands for tag management -->
   <extension point="org.eclipse.ui.commands">
      <category
            id="com.ditrix.edt.mcp.server.tags.category"
            name="Metadata Tags">
      </category>
      <command
            categoryId="com.ditrix.edt.mcp.server.tags.category"
            id="com.ditrix.edt.mcp.server.tags.manageTags"
            name="Manage Tags...">
      </command>
      <command
            categoryId="com.ditrix.edt.mcp.server.tags.category"
            id="com.ditrix.edt.mcp.server.tags.filterByTag"
            name="Filter by Tag..."
            description="Filter navigator by tags">
      </command>
   </extension>
   
   <!-- Handlers for tag commands -->
   <extension point="org.eclipse.ui.handlers">
      <handler
            class="com.ditrix.edt.mcp.server.tags.handlers.ManageTagsHandler"
            commandId="com.ditrix.edt.mcp.server.tags.manageTags">
         <enabledWhen>
            <with variable="selection">
               <count value="1"/>
               <iterate operator="and">
                  <instanceof value="org.eclipse.emf.ecore.EObject"/>
               </iterate>
            </with>
         </enabledWhen>
      </handler>
      <handler
            class="com.ditrix.edt.mcp.server.tags.handlers.FilterByTagHandler"
            commandId="com.ditrix.edt.mcp.server.tags.filterByTag">
      </handler>
   </extension>
   
   <!-- Context menu contributions -->
   <extension point="org.eclipse.ui.menus">
      <!-- Status bar indicator for MCP server in the trim area -->
      <menuContribution
            locationURI="toolbar:org.eclipse.ui.trim.status">
         <toolbar
               id="com.ditrix.edt.mcp.server.statusBar">
            <control
                  class="com.ditrix.edt.mcp.server.ui.McpStatusContribution"
                  id="com.ditrix.edt.mcp.server.status">
            </control>
         </toolbar>
      </menuContribution>
      
      <!-- Filter by Tag button in EDT Navigator toolbar -->
      <menuContribution
            allPopups="false"
            locationURI="toolbar:com._1c.g5.v8.dt.ui2.navigator">
         <command
               commandId="com.ditrix.edt.mcp.server.tags.filterByTag"
               icon="icons/tag.png"
               label="Filter by Tag"
               tooltip="Filter navigator by tags"
               style="push">
         </command>
      </menuContribution>
      
      <!-- Filter by Tag in EDT Navigator view menu -->
      <menuContribution
            allPopups="false"
            locationURI="menu:com._1c.g5.v8.dt.ui2.navigator?after=additions">
         <command
               commandId="com.ditrix.edt.mcp.server.tags.filterByTag"
               icon="icons/tag.png"
               label="Filter by Tag..."
               style="push">
         </command>
      </menuContribution>
      
      <!-- Tag management in EDT navigator context menu -->
      <menuContribution
            allPopups="false"
            locationURI="popup:com._1c.g5.v8.dt.navigator.ui.navigator.popup?after=group.edit">
         <separator name="com.ditrix.edt.mcp.server.tags.separator" visible="true"/>
         <menu
               id="com.ditrix.edt.mcp.server.tags.menu"
               icon="icons/tag.png"
               label="Tags">
            <!-- Dynamic tags list -->
            <dynamic
                  class="com.ditrix.edt.mcp.server.tags.ui.TagsMenuContribution"
                  id="com.ditrix.edt.mcp.server.tags.dynamicTags">
            </dynamic>
            <!-- Manage Tags command at the bottom -->
            <command
                  commandId="com.ditrix.edt.mcp.server.tags.manageTags"
                  label="Manage Tags..."
                  style="push">
               <visibleWhen checkEnabled="false">
                  <with variable="selection">
                     <count value="1"/>
                     <iterate operator="and">
                        <instanceof value="org.eclipse.emf.ecore.EObject"/>
                     </iterate>
                  </with>
               </visibleWhen>
            </command>
         </menu>
      </menuContribution>
   </extension>
   
   <!-- Label decorator for showing tags on metadata objects -->
   <extension point="org.eclipse.ui.decorators">
      <decorator
            class="com.ditrix.edt.mcp.server.tags.ui.TagLabelDecorator"
            id="com.ditrix.edt.mcp.server.tags.decorator"
            label="Metadata Tags Decorator"
            lightweight="true"
            state="true">
         <description>Shows tags assigned to metadata objects</description>
         <enablement>
            <objectClass name="org.eclipse.emf.ecore.EObject"/>
         </enablement>
      </decorator>
   </extension>
   
   <!-- Tag Filter View -->
   <extension point="org.eclipse.ui.views">
      <category
            id="com.ditrix.edt.mcp.server.tags.viewCategory"
            name="MCP Server">
      </category>
      <view
            id="com.ditrix.edt.mcp.server.tags.filterView"
            name="Tag Filter"
            category="com.ditrix.edt.mcp.server.tags.viewCategory"
            class="com.ditrix.edt.mcp.server.tags.ui.TagFilterView"
            allowMultiple="false"
            restorable="true">
         <description>Filter metadata objects by tags</description>
      </view>
   </extension>
   
   <!-- Add Tag Filter View to Window > Show View menu -->
   <extension point="org.eclipse.ui.perspectiveExtensions">
      <perspectiveExtension targetID="*">
         <viewShortcut id="com.ditrix.edt.mcp.server.tags.filterView"/>
      </perspectiveExtension>
   </extension>
   
   <!-- Tag Search Filter for EDT Navigator -->
   <extension point="org.eclipse.ui.navigator.navigatorContent">
      <commonFilter
            id="com.ditrix.edt.mcp.server.tags.TagSearchFilter"
            name="Tag Search Filter"
            description="Filters metadata objects by tag when search starts with #"
            activeByDefault="false"
            visibleInUI="false"
            class="com.ditrix.edt.mcp.server.tags.ui.TagSearchFilter">
      </commonFilter>
   </extension>
   
   <!-- Bind Tag Search Filter to EDT Navigator -->
   <extension point="org.eclipse.ui.navigator.viewer">
      <viewerContentBinding viewerId="com._1c.g5.v8.dt.ui2.navigator">
         <includes>
            <contentExtension pattern="com.ditrix.edt.mcp.server.tags.TagSearchFilter"/>
         </includes>
      </viewerContentBinding>
   </extension>
   
   <!-- Refactoring contributors for tag sync on rename/delete -->
   <extension point="com._1c.g5.v8.dt.refactoring.core.refactoringContributors">
      <contributor
            class="com.ditrix.edt.mcp.server.tags.refactoring.TagRenameRefactoringContributor">
      </contributor>
      <contributor
            class="com.ditrix.edt.mcp.server.tags.refactoring.TagDeleteRefactoringContributor">
      </contributor>
   </extension>
</plugin>
